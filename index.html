<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Peak District Hikes Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css" rel="stylesheet" />

  <style>
    html, body { margin:0; height:100%; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    #app { display:grid; grid-template-columns: 320px 1fr; height:100%; }
    #sidebar {
      background:#111; color:#fff; overflow:auto; border-right:1px solid #222;
    }
    .title { padding:16px 16px 8px; font-weight:700; font-size:18px; }
    .item {
      padding:12px 16px; border-top:1px solid #1e1e1e; cursor:pointer;
      display:flex; gap:10px; align-items:center;
    }
    .item:hover { background:#181818; }
    .dot { width:10px; height:10px; border-radius:50%; background:#EC2629; box-shadow:0 0 0 3px #fff inset; }
    .item.active { background:#1f1f1f; }
    .links { display:flex; gap:10px; margin-left:auto; }
    .links a { color:#9cc9ff; text-decoration:none; font-size:12px; }
    #map { position:relative; }
    #mapCanvas { position:absolute; inset:0; }

    /* custom marker: red circle with white hiker */
    .pin {
      width:28px; height:28px; border-radius:50%;
      background:#EC2629; border:3px solid #fff;
      box-shadow:0 3px 10px rgba(0,0,0,.35);
      display:grid; place-items:center;
    }
    .pin svg { width:14px; height:14px; }
  </style>
</head>
<body>
<div id="app">
  <div id="sidebar">
    <div class="title">Peak District Hikes</div>
    <div id="list"></div>
  </div>
  <div id="map">
    <div id="mapCanvas"></div>
  </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js"></script>
<script src="https://unpkg.com/@tmcw/togeojson@5.8.0/dist/togeojson.umd.js"></script>
<script>
  mapboxgl.accessToken = "pk.eyJ1IjoicmVtbWlhZ2JlYmkiLCJhIjoiY21odHRrYTQzMTk0bjJqcjE1b2xhZ2FraSJ9.nTCz33gX0gQt3T4A6VD0oQ";

  // ---- EDIT THESE (add your GPX raw URLs) ----
  const hikes = [
    {
      id: "derwent-edge",
      name: "Derwent Edge",
      coords: [-1.694, 53.409],
      hikeUrl: "https://thelostpeak.co.uk/hikes/derwent-edge",
      directionsUrl: "https://www.google.com/maps/dir/?api=1&destination=53.409,-1.694",
      gpx: "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/gpx/derwent-edge.gpx",
      animate: true
    },
    {
      id: "crashed-plane",
      name: "The Crashed Plane Hike",
      coords: [-1.8689, 53.4329],
      hikeUrl: "https://thelostpeak.co.uk/hikes/crashed-plane",
      directionsUrl: "https://www.google.com/maps/dir/?api=1&destination=53.4329,-1.8689",
      gpx: "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/gpx/crashed-plane.gpx",
      animate: true
    },
    {
      id: "kinder-scout",
      name: "Kinder Scout",
      coords: [-1.8743, 53.3832],
      hikeUrl: "https://thelostpeak.co.uk/hikes/kinder-scout",
      directionsUrl: "https://www.google.com/maps/dir/?api=1&destination=53.3832,-1.8743",
      gpx: "https://raw.githubusercontent.com/remmiagbebi-beep/peak-district-map/main/gpx/kinder-scout.gpx",
      animate: false
    }
  ];
  // --------------------------------------------

  // Map
  const map = new mapboxgl.Map({
    container: "mapCanvas",
    style: "mapbox://styles/mapbox/satellite-streets-v12",
    center: [-1.78, 53.41],
    zoom: 10
  });
  map.addControl(new mapboxgl.NavigationControl(), "bottom-right");

  // UI: Sidebar list
  const list = document.getElementById("list");
  let activeId = null;
  function renderList(){
    list.innerHTML = "";
    hikes.forEach(h => {
      const row = document.createElement("div");
      row.className = "item";
      row.dataset.id = h.id;
      row.innerHTML = `
        <div class="dot"></div>
        <div>${h.name}</div>
        <div class="links">
          <a href="${h.hikeUrl}" target="_blank" rel="noopener">Hike Page</a>
          <a href="${h.directionsUrl}" target="_blank" rel="noopener">Directions</a>
        </div>
      `;
      row.onclick = () => focusHike(h.id, true);
      list.appendChild(row);
    });
  }
  function setActive(id){
    activeId = id;
    [...document.querySelectorAll(".item")].forEach(el=>{
      el.classList.toggle("active", el.dataset.id===id);
    });
  }

  // Custom marker element (red circle + simple hiker SVG)
  function makePin(){
    const el = document.createElement("div");
    el.className = "pin";
    el.innerHTML = `
      <svg viewBox="0 0 24 24" fill="#fff" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <circle cx="12" cy="5" r="2.2"></circle>
        <path d="M10 22v-6l-2-2 1.5-3 2 2 .5 3.5 3-2 1 1.7-3.6 2.5V22h-2zM15 11l-2-2 2-1.2 2 1.2-2 2z"/>
      </svg>`;
    return el;
  }

  // Popup HTML
  function popupHTML(h){
    return `
      <div style="font-size:14px;">
        <div style="font-weight:700; margin-bottom:4px;">${h.name}</div>
        <div style="margin-bottom:2px;"><a href="${h.hikeUrl}" target="_blank" rel="noopener">Hike Page</a></div>
        <div><a href="${h.directionsUrl}" target="_blank" rel="noopener">Directions</a></div>
      </div>`;
  }

  // Load GPX and add as a line layer
  async function addGpx(h){
    if(!h.gpx) return;
    try{
      const resp = await fetch(h.gpx);
      if(!resp.ok) return;
      const text = await resp.text();
      const xml = new DOMParser().parseFromString(text, "application/xml");
      const gj = toGeoJSON.gpx(xml);
      const line = gj.features.find(f => f.geometry && f.geometry.type === "LineString");
      if(!line) return;

      const sourceId = `route-${h.id}`;
      const layerId  = `route-line-${h.id}`;

      if(!map.getSource(sourceId)){
        map.addSource(sourceId, { type:"geojson", data: line });
        map.addLayer({
          id: layerId,
          type: "line",
          source: sourceId,
          paint: {
            "line-color": "#EC2629",
            "line-width": 4,
            "line-opacity": 0.95
          }
        });

        if(h.animate){
          animateDash(layerId);
        }
      }
    }catch(e){}
  }

  // Simple “draw-on” animation using dasharray
  function animateDash(layerId){
    let t = 0;
    function frame(){
      // dash grows then loops
      const dash = [t, 100 - t];
      map.setPaintProperty(layerId, "line-dasharray", dash);
      t = (t + 1.5) % 100;
      requestAnimationFrame(frame);
    }
    frame();
  }

  // Markers + routes
  const markers = {};
  const popups  = {};

  map.on("load", async () => {
    renderList();

    // fit bounds around all points
    const bounds = new mapboxgl.LngLatBounds();
    hikes.forEach(h => bounds.extend(h.coords));
    map.fitBounds(bounds, { padding: 40 });

    for(const h of hikes){
      // marker
      const marker = new mapboxgl.Marker({ element: makePin() })
        .setLngLat(h.coords)
        .addTo(map);

      const popup = new mapboxgl.Popup({ offset: 28 }).setHTML(popupHTML(h));
      marker.setPopup(popup);

      marker.getElement().addEventListener("click", () => {
        setActive(h.id);
        popup.addTo(map);
      });

      markers[h.id] = marker;
      popups[h.id]  = popup;

      // route
      await addGpx(h);
    }
  });

  // Focus a hike from the sidebar
  function focusHike(id, openPopup){
    const h = hikes.find(x => x.id === id);
    if(!h) return;
    map.easeTo({ center: h.coords, zoom: 12.5, duration: 900 });
    setActive(id);
    if(openPopup && popups[id]) popups[id].addTo(map);
  }

  // OPTIONAL: clustering (useful only if you have many markers close together).
  // With a handful of hikes you don’t need this. If you later have dozens,
  // move markers into a GeoJSON source with "cluster: true" and show cluster circles.
  // Happy to wire that when you have lots of points.
</script>
</body>
</html>
